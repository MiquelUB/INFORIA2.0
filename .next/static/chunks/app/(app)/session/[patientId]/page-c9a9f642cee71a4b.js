(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[192],{7214:function(e,t,a){Promise.resolve().then(a.bind(a,189))},189:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return U}});var n=a(7437),o=a(2265),r=a(9376),s=a(6070),i=a(2869),c=a(6818),l=a(5974),d=a(8736),p=a(9205);let u=(0,p.Z)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),m=(0,p.Z)("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]);var h=a(8930),g=a(3229);let f=(0,p.Z)("wand-sparkles",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]);var v=a(6865),w=a(1047),y=a(6362),x=a(4438),N=a(4498);let b=(0,p.Z)("file-audio",[["path",{d:"M17.5 22h.5a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3",key:"rslqgf"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M2 19a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0v-4a6 6 0 0 1 12 0v4a2 2 0 1 1-4 0v-1a2 2 0 1 1 4 0",key:"9f7x3i"}]]),E=(0,p.Z)("file",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]),A=(0,p.Z)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);var j=a(2489),I=a(4508),C=e=>{let{files:t,onFilesSelected:a,onFileRemove:r,acceptedTypes:c=".wav,.mp3,.m4a,.txt,.pdf,.doc,.docx",maxFiles:p=10,isDisabled:u=!1,className:m}=e,h=(0,o.useRef)(null),g=e=>e.type.startsWith("audio/")?(0,n.jsx)(b,{className:"w-4 h-4"}):e.type.startsWith("text/")||e.name.endsWith(".txt")?(0,n.jsx)(d.Z,{className:"w-4 h-4"}):(0,n.jsx)(E,{className:"w-4 h-4"}),f=e=>{if(0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]};return(0,n.jsxs)("div",{className:(0,I.cn)("space-y-4",m),children:[(0,n.jsx)(s.Zb,{className:(0,I.cn)("border-2 border-dashed cursor-pointer transition-colors",u?"border-gray-300 cursor-not-allowed":"border-gray-400 hover:border-primary",t.length>=p&&"cursor-not-allowed opacity-50"),onDragOver:e=>{e.preventDefault()},onDrop:e=>{e.preventDefault();let t=e.dataTransfer.files;t.length>0&&a(t)},onClick:!u&&t.length<p?()=>{var e;null===(e=h.current)||void 0===e||e.click()}:void 0,children:(0,n.jsxs)(s.aY,{className:"p-8 text-center",children:[(0,n.jsx)(A,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),(0,n.jsx)("p",{className:"text-lg font-medium mb-2",children:"Seleccionar archivos"}),(0,n.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"Arrastra archivos aqu\xed o haz clic para seleccionar"}),(0,n.jsxs)("p",{className:"text-xs text-gray-400",children:["Tipos permitidos: ",c]})]})}),(0,n.jsx)("input",{ref:h,type:"file",multiple:!0,accept:c,onChange:e=>{let t=e.target.files;t&&t.length>0&&a(t),h.current&&(h.current.value="")},className:"hidden",disabled:u||t.length>=p}),t.length>0&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("h4",{className:"font-medium text-sm",children:["Archivos seleccionados (",t.length,")"]}),t.map((e,t)=>(0,n.jsx)(s.Zb,{className:"p-3",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[g(e),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium truncate max-w-[200px]",children:e.name}),(0,n.jsx)("p",{className:"text-xs text-gray-500",children:f(e.size)})]}),(0,n.jsx)(l.C,{variant:"outline",className:"ml-2",children:e.type.split("/")[0]})]}),(0,n.jsx)(i.z,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),r(t)},className:"text-red-500 hover:text-red-700",children:(0,n.jsx)(j.Z,{className:"w-4 h-4"})})]})},t))]})]})};let S=(e,t)=>{let[a,n]=(0,o.useState)([]),[r,s]=(0,o.useState)(!1),i=(0,o.useCallback)(t=>{let a=new Date,n=a.toISOString().split("T")[0].replace(/-/g,""),o=a.toTimeString().split(" ")[0].replace(/:/g,""),r=e||"XX",s=t.split(".").pop();return"".concat(n,"_").concat(o,"_").concat(r,".").concat(s)},[e]);return{selectedFiles:a,isUploading:r,uploadFiles:(0,o.useCallback)(async e=>{s(!0);try{let a=Array.from(e).map(e=>{let t=i(e.name);return new File([e],t,{type:e.type})});n(e=>[...e,...a]),null==t||t(a),x.Am.success("".concat(a.length," archivo(s) seleccionado(s)"))}catch(e){console.error("Error uploading files:",e),x.Am.error("Error al procesar archivos")}finally{s(!1)}},[i,t]),removeFile:(0,o.useCallback)(e=>{n(t=>t.filter((t,a)=>a!==e))},[]),clearFiles:(0,o.useCallback)(()=>{n([])},[])}},T=(e,t)=>{let[a,n]=(0,o.useState)(!1),[r,s]=(0,o.useState)("00:00"),[i,c]=(0,o.useState)(null),l=(0,o.useRef)(null),d=(0,o.useRef)(null),p=(0,o.useRef)(null),u=(0,o.useRef)(0),m=(0,o.useCallback)(()=>{let t=new Date,a=t.toISOString().split("T")[0].replace(/-/g,""),n=t.toTimeString().split(" ")[0].replace(/:/g,""),o=e||"XX";return"".concat(a,"_").concat(n,"_").concat(o,"_session.wav")},[e]),h=(0,o.useCallback)(()=>{let e=Date.now()-u.current;s("".concat(Math.floor(e/6e4).toString().padStart(2,"0"),":").concat(Math.floor(e%6e4/1e3).toString().padStart(2,"0")))},[]),g=(0,o.useCallback)(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}});d.current=e;let a=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus"});l.current=a;let o=[];a.ondataavailable=e=>{e.data.size>0&&o.push(e.data)},a.onstop=()=>{let e=new Blob(o,{type:"audio/wav"});c(e);let a=m();null==t||t(e,a),d.current&&(d.current.getTracks().forEach(e=>e.stop()),d.current=null)},a.start(1e3),n(!0),u.current=Date.now(),p.current=setInterval(h,1e3),x.Am.success("Grabaci\xf3n iniciada")}catch(e){console.error("Error accessing microphone:",e),x.Am.error("Error al acceder al micr\xf3fono. Verifica los permisos.")}},[m,t,h]),f=(0,o.useCallback)(()=>{l.current&&a&&(l.current.stop(),n(!1),p.current&&(clearInterval(p.current),p.current=null),x.Am.success("Grabaci\xf3n finalizada"))},[a]),v=(0,o.useCallback)(()=>{c(null),s("00:00"),x.Am.success("Grabaci\xf3n eliminada")},[]),w=(0,o.useCallback)(()=>{i&&new Audio(URL.createObjectURL(i)).play()},[i]);return{isRecording:a,recordingTime:r,audioBlob:i,startRecording:g,stopRecording:f,deleteRecording:v,playRecording:w}};var k=a(6281),O=a(6467),R=a(970);let D=(0,R.e)();class P{async getAccessToken(){try{let{data:{session:e},error:t}=await D.auth.getSession();if(t||!(null==e?void 0:e.provider_token))return console.error("No hay token de Google disponible:",t),null;return e.provider_token}catch(e){return console.error("Error obteniendo token:",e),null}}async hasPermissions(){let e=await this.getAccessToken();if(!e)return!1;try{return(await fetch("https://www.googleapis.com/drive/v3/about?fields=user",{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}})).ok}catch(e){return console.error("Error verificando permisos de Drive:",e),!1}}async getOrCreateInforiaFolder(){let e=await this.getAccessToken();if(!e)return null;try{let t=await fetch("https://www.googleapis.com/drive/v3/files?q=name='".concat(P.FOLDER_NAME,"' and mimeType='application/vnd.google-apps.folder' and trashed=false"),{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!t.ok)throw Error("Error buscando carpeta iNFORiA_INFORMES");let a=await t.json();if(a.files&&a.files.length>0)return a.files[0].id;let n=await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({name:P.FOLDER_NAME,mimeType:"application/vnd.google-apps.folder"})});if(!n.ok)throw Error("Error creando carpeta iNFORiA_INFORMES");let o=await n.json();return console.log("✅ Carpeta iNFORiA_INFORMES creada:",o.id),o.id}catch(e){return console.error("Error gestionando carpeta iNFORiA_INFORMES:",e),null}}async getOrCreatePatientFolder(e,t){let a=await this.getAccessToken();if(!a)return null;try{let n=await this.getOrCreateInforiaFolder();if(!n)return null;let o=e.replace(/[<>:"/\\|?*]/g,"_").trim(),r="".concat(o,"_").concat(t.substring(0,8)),s=await fetch("https://www.googleapis.com/drive/v3/files?q=name='".concat(r,"' and '").concat(n,"' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"),{headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"}});if(!s.ok)throw Error("Error buscando carpeta del paciente");let i=await s.json();if(i.files&&i.files.length>0)return i.files[0].id;let c=await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify({name:r,parents:[n],mimeType:"application/vnd.google-apps.folder"})});if(!c.ok)throw Error("Error creando carpeta del paciente");let l=await c.json();return console.log("✅ Carpeta del paciente creada en iNFORiA_INFORMES:",l.id),l.id}catch(e){return console.error("Error gestionando carpeta del paciente:",e),null}}async createPatientReport(e,t,a,n){try{let o=await this.getAccessToken();if(!o)return{fileId:"",webViewLink:"",success:!1,message:"No tienes permisos de Google Drive. Re-autentica tu cuenta."};let r=await this.getOrCreatePatientFolder(a,n);if(!r)return{fileId:"",webViewLink:"",success:!1,message:"Error creando carpeta del paciente"};let s=new Date().toISOString().split("T")[0],i="".concat(s," - ").concat(e),c=await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({name:i,parents:[r],mimeType:"application/vnd.google-apps.document"})});if(!c.ok)throw Error("Error creando documento en Drive");let l=await c.json(),d=[{insertText:{location:{index:1},text:"".concat(e,"\n\n").concat(t)}},{updateTextStyle:{range:{startIndex:1,endIndex:e.length+1},textStyle:{bold:!0,fontSize:{magnitude:16,unit:"PT"}},fields:"bold,fontSize"}}];return(await fetch("https://docs.googleapis.com/v1/documents/".concat(l.id,":batchUpdate"),{method:"POST",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({requests:d})})).ok||console.warn("Documento creado pero error al formatear contenido"),console.log("✅ Informe guardado en carpeta del paciente:",l.id),{fileId:l.id,webViewLink:"https://docs.google.com/document/d/".concat(l.id,"/edit"),success:!0,message:"Informe guardado exitosamente en Google Drive"}}catch(e){return console.error("Error creando documento en Drive:",e),{fileId:"",webViewLink:"",success:!1,message:e instanceof Error?e.message:"Error desconocido"}}}async createReport(e,t){try{let a=await this.getAccessToken();if(!a)return{fileId:"",webViewLink:"",success:!1,message:"No tienes permisos de Google Drive. Re-autentica tu cuenta."};let n=await this.getOrCreateInforiaFolder();if(!n)return{fileId:"",webViewLink:"",success:!1,message:"Error accediendo a la carpeta de informes"};let o=await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify({name:"".concat(e,".gdoc"),parents:[n],mimeType:"application/vnd.google-apps.document"})});if(!o.ok)throw Error("Error creando documento en Drive");let r=await o.json(),s=[{insertText:{location:{index:1},text:"".concat(e,"\n\n").concat(t)}},{updateTextStyle:{range:{startIndex:1,endIndex:e.length+1},textStyle:{bold:!0,fontSize:{magnitude:16,unit:"PT"}},fields:"bold,fontSize"}}];return(await fetch("https://docs.googleapis.com/v1/documents/".concat(r.id,":batchUpdate"),{method:"POST",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify({requests:s})})).ok||console.warn("Documento creado pero error al formatear contenido"),console.log("✅ Informe guardado en Google Drive:",r.id),{fileId:r.id,webViewLink:"https://docs.google.com/document/d/".concat(r.id,"/edit"),success:!0,message:"Informe guardado exitosamente en Google Drive"}}catch(e){return console.error("Error creando documento en Drive:",e),{fileId:"",webViewLink:"",success:!1,message:e instanceof Error?e.message:"Error desconocido"}}}async listReports(){try{let e=await this.getAccessToken();if(!e)return[];let t=await this.getOrCreateInforiaFolder();if(!t)return[];let a=await fetch("https://www.googleapis.com/drive/v3/files?q='".concat(t,"' in parents and mimeType='application/vnd.google-apps.document' and trashed=false&fields=files(id,name,webViewLink,webContentLink,createdTime)&orderBy=createdTime desc"),{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!a.ok)throw Error("Error listando informes");return(await a.json()).files||[]}catch(e){return console.error("Error listando informes:",e),[]}}async listPatientReports(e,t){try{let a=await this.getAccessToken();if(!a)return[];let n=await this.getOrCreatePatientFolder(e,t);if(!n)return[];let o=await fetch("https://www.googleapis.com/drive/v3/files?q='".concat(n,"' in parents and mimeType='application/vnd.google-apps.document' and trashed=false&fields=files(id,name,webViewLink,webContentLink,createdTime)&orderBy=createdTime desc"),{headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"}});if(!o.ok)throw Error("Error listando informes del paciente");return(await o.json()).files||[]}catch(e){return console.error("Error listando informes del paciente:",e),[]}}async checkFileExists(e){try{let t=await this.getAccessToken();if(!t)return!1;let a=await fetch("https://www.googleapis.com/drive/v3/files/".concat(e,"?fields=id,trashed"),{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(!a.ok)return!1;return!(await a.json()).trashed}catch(e){return console.error("Error verificando archivo:",e),!1}}async requestPermissions(){try{let{error:e}=await D.auth.signInWithOAuth({provider:"google",options:{scopes:P.SCOPES.join(" "),redirectTo:"".concat(window.location.origin,"/"),queryParams:{access_type:"offline",prompt:"consent"}}});if(e)return console.error("Error solicitando permisos:",e),!1;return!0}catch(e){return console.error("Error en requestPermissions:",e),!1}}async getPatientFolderUrl(e,t){try{let a=await this.getOrCreatePatientFolder(e,t);if(!a)return null;return"https://drive.google.com/drive/folders/".concat(a)}catch(e){return console.error("Error obteniendo URL de carpeta del paciente:",e),null}}}P.FOLDER_NAME="iNFORiA_INFORMES",P.SCOPES=["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.folders","https://www.googleapis.com/auth/documents"];let _=new P,M=(0,R.e)();class F{async getAccessToken(){try{let{data:{session:e},error:t}=await M.auth.getSession();if(t||!(null==e?void 0:e.provider_token))return console.error("No hay token de Google disponible:",t),null;return e.provider_token}catch(e){return console.error("Error obteniendo token:",e),null}}async getOrCreateCRMSheet(){try{let e=await this.getAccessToken();if(!e)return null;let t=await fetch("https://www.googleapis.com/drive/v3/files?q=name='".concat(F.CRM_SHEET_NAME,"' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false"),{headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!t.ok)throw Error("Error buscando CRM Sheet");let a=await t.json();if(a.files&&a.files.length>0)return a.files[0].id;let n=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({properties:{title:F.CRM_SHEET_NAME},sheets:[{properties:{title:"Pacientes"}},{properties:{title:"Pagos"}},{properties:{title:"Informes"}}]})});if(!n.ok)throw Error("Error creando CRM Sheet");let o=(await n.json()).spreadsheetId;return await this.setupPatientsSheet(o),await this.setupPaymentsSheet(o),await this.setupReportsSheet(o),console.log("✅ CRM Sheet creado:",o),o}catch(e){return console.error("Error gestionando CRM Sheet:",e),null}}async setupPatientsSheet(e){let t=await this.getAccessToken();if(t)try{await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(e,"/values/Pacientes!A1:N1?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({values:[["ID","Nombre Completo","Email","Tel\xe9fono","Fecha Nacimiento","Fecha Alta","Total Informes","\xdaltimo Informe","Estado Pago","Total Pagado €","Pr\xf3ximo Pago","Estado Paciente","Notas","Carpeta Drive"]]})}),await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(e,":batchUpdate"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({requests:[{repeatCell:{range:{sheetId:0,startRowIndex:0,endRowIndex:1,startColumnIndex:0,endColumnIndex:14},cell:{userEnteredFormat:{backgroundColor:{red:.18,green:.25,blue:.23},textFormat:{foregroundColor:{red:1,green:1,blue:1},bold:!0}}},fields:"userEnteredFormat"}}]})})}catch(e){console.error("Error configurando hoja Pacientes:",e)}}async setupPaymentsSheet(e){let t=await this.getAccessToken();if(t)try{await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(e,"/values/Pagos!A1:H1?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({values:[["Fecha","ID Paciente","Nombre Paciente","Concepto","Cantidad €","M\xe9todo Pago","Estado","Notas"]]})}),await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(e,":batchUpdate"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({requests:[{repeatCell:{range:{sheetId:1,startRowIndex:0,endRowIndex:1,startColumnIndex:0,endColumnIndex:8},cell:{userEnteredFormat:{backgroundColor:{red:.5,green:0,blue:.125},textFormat:{foregroundColor:{red:1,green:1,blue:1},bold:!0}}},fields:"userEnteredFormat"}}]})})}catch(e){console.error("Error configurando hoja Pagos:",e)}}async setupReportsSheet(e){let t=await this.getAccessToken();if(t)try{await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(e,"/values/Informes!A1:H1?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({values:[["Fecha","ID Paciente","Nombre Paciente","Tipo Informe","T\xedtulo","Estado","Link Google Docs","M\xe9todo Input"]]})})}catch(e){console.error("Error configurando hoja Informes:",e)}}async upsertPatientInCRM(e,t){try{let a=await this.getAccessToken();if(!a)return!1;let n=t||await this.getOrCreateCRMSheet();if(!n)return!1;let o=await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(n,"/values/Pacientes!A:A"),{headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"}});if(!o.ok)throw Error("Error buscando pacientes en CRM");let r=(await o.json()).values||[],s=-1;for(let t=1;t<r.length;t++)if(r[t][0]===e.id){s=t+1;break}let i=[e.id,e.name,e.email||"",e.phone||"",e.birth_date||"",e.created_at,e.total_reports.toString(),e.last_report_date||"",e.payment_status,e.total_paid.toString(),e.next_payment_due||"",e.status,e.notes||"",e.drive_folder_url||""];if(s>0)await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(n,"/values/Pacientes!A").concat(s,":N").concat(s,"?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify({values:[i]})});else{let e=r.length+1;await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(n,"/values/Pacientes!A").concat(e,":N").concat(e,"?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify({values:[i]})})}return console.log("✅ Paciente actualizado en CRM:",e.name),!0}catch(e){return console.error("Error actualizando paciente en CRM:",e),!1}}async addReportToCRM(e,t){try{var a;let n=await this.getAccessToken();if(!n)return!1;let o=t||await this.getOrCreateCRMSheet();if(!o)return!1;let r=await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(o,"/values/Informes!A:A"),{headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"}});if(!r.ok)throw Error("Error obteniendo datos de informes");let s=await r.json(),i=((null===(a=s.values)||void 0===a?void 0:a.length)||0)+1,c=[e.date,e.patientId,e.patientName,e.reportType,e.title,e.status,e.driveLink,e.inputMethod];return await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(o,"/values/Informes!A").concat(i,":H").concat(i,"?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify({values:[c]})}),console.log("✅ Informe agregado al CRM"),!0}catch(e){return console.error("Error agregando informe al CRM:",e),!1}}async addPaymentToCRM(e,t){try{var a;let n=await this.getAccessToken();if(!n)return!1;let o=t||await this.getOrCreateCRMSheet();if(!o)return!1;let r=await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(o,"/values/Pagos!A:A"),{headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"}});if(!r.ok)throw Error("Error obteniendo datos de pagos");let s=await r.json(),i=((null===(a=s.values)||void 0===a?void 0:a.length)||0)+1,c=[e.date,e.patientId,e.patientName,e.concept,e.amount.toString(),e.paymentMethod,e.status,e.notes||""];return await fetch("https://sheets.googleapis.com/v4/spreadsheets/".concat(o,"/values/Pagos!A").concat(i,":H").concat(i,"?valueInputOption=RAW"),{method:"PUT",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify({values:[c]})}),console.log("✅ Pago agregado al CRM"),!0}catch(e){return console.error("Error agregando pago al CRM:",e),!1}}getCRMViewUrl(e){return"https://docs.google.com/spreadsheets/d/".concat(e,"/edit")}}F.CRM_SHEET_NAME="iNFORiA_CRM_PACIENTES";let z=new F;var B=a(257);class L{async transcribeAudio(e){try{let t=new FormData;t.append("file",e,"session_audio.wav"),t.append("model","whisper-1"),t.append("response_format","json"),t.append("language","es"),t.append("prompt","Esta es una sesi\xf3n terap\xe9utica en espa\xf1ol. Incluye t\xe9rminos psicol\xf3gicos y m\xe9dicos.");let a=await fetch("".concat(this.baseUrl,"/audio/transcriptions"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.apiKey),"HTTP-Referer":window.location.origin,"X-Title":"INFORIA Clinical Assistant"},body:t});if(!a.ok){let e=await a.text();throw Error("Whisper transcription error: ".concat(a.status," ").concat(a.statusText," - ").concat(e))}return(await a.json()).text}catch(e){throw console.error("Error en transcripci\xf3n de audio:",e),Error(e instanceof Error?e.message:"Error desconocido en transcripci\xf3n")}}async compileReportInfo(e){var t,a;return({nuevo_paciente:"\nTIPO: PRIMER INFORME - PACIENTE NUEVO\nPaciente: ".concat(e.patientData.name,"\nEdad: ").concat(e.patientData.age||"No especificada","\nFecha de consulta: ").concat(e.sessionData.sessionDate,"\n\nTRANSCRIPCI\xd3N DE AUDIO:\n").concat(e.sessionData.audioTranscription||"No disponible","\n\nNOTAS CL\xcdNICAS:\n").concat(e.sessionData.clinicalNotes,"\n\nINSTRUCCIONES:\nGenera un primer informe completo que incluya:\n1. Anamnesis inicial completa\n2. Motivo de consulta principal\n3. Historia cl\xednica relevante\n4. Exploraci\xf3n psicopatol\xf3gica\n5. Impresi\xf3n diagn\xf3stica inicial\n6. Plan de tratamiento propuesto\n7. Objetivos terap\xe9uticos\n\nFormato: Informe cl\xednico profesional en markdown\n"),seguimiento:"\nTIPO: INFORME DE SEGUIMIENTO\nPaciente: ".concat(e.patientData.name,"\nFecha actual: ").concat(e.sessionData.sessionDate,"\nPrimera visita: ").concat(e.patientData.firstVisitDate||"No registrada","\n\nTRANSCRIPCI\xd3N SESI\xd3N ACTUAL:\n").concat(e.sessionData.audioTranscription||"No disponible","\n\nNOTAS SESI\xd3N ACTUAL:\n").concat(e.sessionData.clinicalNotes,"\n\nINFORMES PREVIOS:\n").concat((null===(t=e.patientData.previousReports)||void 0===t?void 0:t.join("\n---\n"))||"No disponibles","\n\nINSTRUCCIONES:\nGenera un informe de seguimiento que incluya:\n1. Evoluci\xf3n desde la \xfaltima sesi\xf3n\n2. Progreso en objetivos terap\xe9uticos\n3. Nuevas observaciones cl\xednicas\n4. Cambios en el estado mental\n5. Adherencia al tratamiento\n6. Ajustes al plan terap\xe9utico\n7. Pr\xf3ximos pasos y recomendaciones\n\nCompara con informes previos y destaca cambios significativos.\nFormato: Informe evolutivo en markdown\n"),alta_paciente:"\nTIPO: DOSSIER DE ALTA - INFORME FINAL\nPaciente: ".concat(e.patientData.name,"\nInicio tratamiento: ").concat(e.patientData.firstVisitDate||"No registrado","\nFecha de alta: ").concat(e.sessionData.sessionDate,"\n\nTRANSCRIPCI\xd3N SESI\xd3N FINAL:\n").concat(e.sessionData.audioTranscription||"No disponible","\n\nNOTAS FINALES:\n").concat(e.sessionData.clinicalNotes,"\n\nHISTORIAL COMPLETO:\n").concat((null===(a=e.patientData.previousReports)||void 0===a?void 0:a.join("\n---\n"))||"No disponible","\n\nINSTRUCCIONES:\nGenera un dossier completo de alta que incluya:\n1. RESUMEN EJECUTIVO del caso completo\n2. EVOLUCI\xd3N CRONOL\xd3GICA del tratamiento\n3. OBJETIVOS ALCANZADOS y pendientes\n4. DIAGN\xd3STICO FINAL y pron\xf3stico\n5. HERRAMIENTAS Y T\xc9CNICAS utilizadas\n6. RECOMENDACIONES POST-ALTA\n7. PLAN DE SEGUIMIENTO (si aplica)\n8. RECURSOS Y DERIVACIONES sugeridas\n\nEste debe ser un informe integral y definitivo.\nFormato: Dossier profesional completo en markdown\n")})[e.reportType]}async generateReport(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"nuevo_paciente",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"deepseek/deepseek-r1";try{var n,o;let r=await fetch("".concat(this.baseUrl,"/chat/completions"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.apiKey),"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"INFORIA Clinical Assistant"},body:JSON.stringify({model:a,messages:[{role:"system",content:{nuevo_paciente:"Eres un psic\xf3logo cl\xednico experto con 20+ a\xf1os de experiencia. Generas informes profesionales, precisos y emp\xe1ticos para primeras consultas.",seguimiento:"Eres un psic\xf3logo cl\xednico especializado en seguimiento terap\xe9utico. Eval\xfaas evoluci\xf3n y progresos con criterio profesional.",alta_paciente:"Eres un psic\xf3logo cl\xednico con expertise en cierres de tratamiento. Generas dossiers completos de alta con visi\xf3n integral del proceso."}[t]},{role:"user",content:e}],max_tokens:3e3,temperature:.7,top_p:.9})});if(!r.ok){let e=await r.text();throw Error("Report generation error: ".concat(r.status," ").concat(r.statusText," - ").concat(e))}let s=await r.json();return(null===(o=s.choices[0])||void 0===o?void 0:null===(n=o.message)||void 0===n?void 0:n.content)||"Error al generar el informe"}catch(e){throw console.error("Error en generaci\xf3n de informe:",e),Error(e instanceof Error?e.message:"Error desconocido en generaci\xf3n de informe")}}async processFullReport(e){try{let t=await this.compileReportInfo(e);return await this.generateReport(t,e.reportType,e.selectedModel||"deepseek/deepseek-r1")}catch(e){throw console.error("Error en procesamiento completo:",e),Error(e instanceof Error?e.message:"Error en procesamiento del informe")}}async testConnection(){try{return(await fetch("".concat(this.baseUrl,"/models"),{method:"GET",headers:{Authorization:"Bearer ".concat(this.apiKey),"HTTP-Referer":window.location.origin}})).ok}catch(e){return!1}}constructor(){this.baseUrl="https://openrouter.ai/api/v1",this.apiKey=B.env.NEXT_PUBLIC_OPENROUTER_API_KEY||"",this.apiKey||console.warn("⚠️ OPENROUTER_API_KEY no configurada")}}let G=new L;function U(e){let{params:t}=e,a=(0,r.useRouter)(),{user:p}=(0,k.a)(),[b,E]=(0,o.useState)(null),[A,j]=(0,o.useState)(""),[I,R]=(0,o.useState)("primera_visita"),[D,P]=(0,o.useState)(!1),[M,F]=(0,o.useState)(!1),[B,L]=(0,o.useState)(""),[U,Z]=(0,o.useState)(null),[V,q]=(0,o.useState)("unknown"),[H,J]=(0,o.useState)("unknown"),[W,Y]=(0,o.useState)([]),K=t.patientId,X=b?b.name.split(" ").map(e=>e[0]).join("").toUpperCase():void 0,{selectedFiles:Q,uploadFiles:$,removeFile:ee,clearFiles:et}=S(X),{isRecording:ea,recordingTime:en,audioBlob:eo,startRecording:er,stopRecording:es,deleteRecording:ei,playRecording:ec}=T(X);(0,o.useEffect)(()=>{(async()=>{if((null==p?void 0:p.id)&&K)try{let e=await O.Wd.getById(K);if(e){E(e);let t=await O.qi.getByPatient(K);Y(t)}}catch(e){console.error("Error loading patient:",e),x.Am.error("Error al cargar datos del paciente")}})()},[null==p?void 0:p.id,K]),(0,o.useEffect)(()=>{(async()=>{!eo||ea||M||await ed()})()},[eo,ea]);let el=async()=>{var e,t,a,n;console.log("\uD83E\uDDEA Testing OpenRouter connectivity...");let o=(void 0).VITE_OPENROUTER_API_KEY;console.log("\uD83D\uDD11 API Key debug info:",{exists:!!o,length:null==o?void 0:o.length,firstChars:null==o?void 0:o.substring(0,15),lastChars:null==o?void 0:o.substring((null==o?void 0:o.length)-5),hasNewlines:null==o?void 0:o.includes("\n"),hasSpaces:null==o?void 0:o.includes(" "),hasTabs:null==o?void 0:o.includes("	"),isString:typeof o});try{console.log("\uD83C\uDF10 Attempting fetch to OpenRouter...");let n=null==o?void 0:o.trim(),r={Authorization:"Bearer ".concat(n),"Content-Type":"application/json"};console.log("\uD83D\uDCCB Headers debug:",{authHeaderLength:null===(e=r.Authorization)||void 0===e?void 0:e.length,authStarts:null===(t=r.Authorization)||void 0===t?void 0:t.substring(0,20),contentType:r["Content-Type"]});let s=await fetch("https://openrouter.ai/api/v1/models",{method:"GET",headers:r});if(console.log("\uD83D\uDCE1 OpenRouter response:",{status:s.status,ok:s.ok,statusText:s.statusText}),s.ok){let e=await s.json();return console.log("✅ OpenRouter conectado - Modelos:",(null===(a=e.data)||void 0===a?void 0:a.length)||0),!0}{let e=await s.text();return console.log("❌ OpenRouter error response:",e),!1}}catch(e){return console.log("❌ Fetch exception details:",{name:e.name,message:e.message,stack:null===(n=e.stack)||void 0===n?void 0:n.substring(0,200)}),!1}},ed=async()=>{if(!eo){x.Am.error("No hay audio para transcribir");return}F(!0);try{if(console.log("\uD83C\uDFA4 Intentando transcribir audio con Whisper..."),!await el())throw Error("OpenRouter no disponible");let e=await G.transcribeAudio(eo);L(e),q("working"),x.Am.success("Audio transcrito correctamente con IA"),console.log("✅ Transcripci\xf3n completada:",e.substring(0,100)+"...")}catch(e){console.error("Error transcribing audio:",e),q("fallback"),L("[AUDIO GRABADO - ".concat(en,"]\nArchivo: ").concat(new Date().toLocaleDateString(),"_").concat(en,"_").concat(X,"_session.wav\nDuraci\xf3n: ").concat(en,"\nEstado: Pendiente transcripci\xf3n manual\nNota: La transcripci\xf3n autom\xe1tica no est\xe1 disponible.\nPor favor, revise el audio manualmente.")),x.Am.error("Transcripci\xf3n autom\xe1tica no disponible. Usando informaci\xf3n b\xe1sica del audio.")}finally{F(!1)}},ep=(e,t)=>"# ".concat(e,"\n\n## INFORMACI\xd3N DE LA SESI\xd3N\n- **Fecha**: ").concat(t,"\n- **Paciente**: ").concat(null==b?void 0:b.name,"\n- **Tipo de consulta**: ").concat(em(I),"\n- **Profesional**: ").concat(null==p?void 0:p.email,"\n\n## DESARROLLO DE LA SESI\xd3N\n\n").concat(A.trim()?"### Observaciones Cl\xednicas\n".concat(A.trim(),"\n\n"):"","\n\n").concat(B?"### Registro de Audio\n".concat(B,"\n\n"):"","\n\n").concat(Q.length>0?"### Documentaci\xf3n Adjunta\n".concat(Q.map((e,t)=>"".concat(t+1,". ").concat(e.name," (").concat(Math.round(e.size/1024)," KB)")).join("\n"),"\n\n"):"","\n\n## EVALUACI\xd3N Y SEGUIMIENTO\n\n### Estado Actual\n- Sesi\xf3n documentada completamente\n- ").concat(eo?"Incluye grabaci\xf3n de audio":"Sesi\xf3n basada en notas escritas","\n- ").concat(Q.length>0?"".concat(Q.length," documento(s) adicional(es)"):"Sin documentaci\xf3n adicional","\n\n### Pr\xf3ximos Pasos\n- Revisar contenido de la sesi\xf3n\n- ").concat("primera_visita"===I?"Planificar seguimiento inicial":"Continuar con plan terap\xe9utico establecido","\n- Actualizar historial cl\xednico\n\n---\n*Informe generado autom\xe1ticamente el ").concat(new Date().toLocaleString(),"*\n*Sistema: iNFORiA Clinical Assistant*"),eu=async()=>{if(!b||!A.trim()&&!B.trim()&&0===Q.length){x.Am.error("Por favor proporciona contenido para el informe");return}P(!0);try{let e,t;console.log("\uD83D\uDE80 Generando informe con sistema h\xedbrido IA/Estructurado:",{patient:b.name,type:I,hasAudio:!!eo,hasTranscription:!!B,filesCount:Q.length,notesLength:A.length});let a=new Date().toISOString().split("T")[0],n="".concat(em(I)," - ").concat(b.name," - ").concat(a),o="structured";if(A.trim()||B.trim())try{if(console.log("\uD83E\uDD16 Intentando generar informe con IA..."),!await el())throw Error("OpenRouter no disponible - usando fallback estructurado");let t="seguimiento"===I?await O.qi.getByPatient(b.id):[],n={name:b.name,age:b.birth_date?Math.floor((Date.now()-new Date(b.birth_date).getTime())/315576e5):void 0,previousReports:t.map(e=>e.content||"").slice(0,3),firstVisitDate:b.created_at||void 0},r={audioTranscription:B||void 0,clinicalNotes:A.trim(),sessionDate:a},s=await G.compileReportInfo({reportType:"primera_visita"===I?"nuevo_paciente":"seguimiento",patientData:n,sessionData:r});e=await G.generateReport(s),o="ai-generated",q("working"),console.log("✅ IA gener\xf3 informe exitosamente")}catch(t){console.warn("⚠️ Error IA, usando contenido estructurado:",t),q("fallback"),e=ep(n,a),o="structured-fallback"}else e=ep(n,a),o="structured-direct";console.log("\uD83D\uDCDD Informe generado con m\xe9todo:",o);let r=!1;try{if((t=await _.createPatientReport(n,e,b.name,b.id)).success)r=!0,J("working"),console.log("\uD83D\uDCBE Informe guardado en Google Drive:",t.fileId);else throw Error(t.message)}catch(e){console.warn("⚠️ Error Google Drive:",e),J("no-permissions"),t={fileId:"",webViewLink:"",success:!1,message:"Sin permisos de Google Drive"}}let s={user_id:p.id,patient_id:b.id,title:n,content:e,report_type:I,input_type:eo?"voice":Q.length>0?"mixed":"text",google_drive_file_id:(null==t?void 0:t.fileId)||null,status:"completed",audio_transcription:B||void 0},i=await O.qi.create(s);if(console.log("\uD83D\uDCBD Informe guardado en base de datos:",i.id),r)try{await z.addReportToCRM({date:a,patientId:b.id,patientName:b.name,reportType:em(I),title:n,status:"Completado",driveLink:t.webViewLink,inputMethod:"".concat(o," + ").concat(eo?"audio":Q.length>0?"archivos":"notas")});let e=await O.qi.getByPatient(b.id),r=await _.getPatientFolderUrl(b.name,b.id);await z.upsertPatientInCRM({id:b.id,name:b.name,email:b.email||void 0,phone:b.phone||void 0,birth_date:b.birth_date||void 0,created_at:b.created_at||new Date().toISOString(),total_reports:e.length+1,last_report_date:a,payment_status:"Pendiente",total_paid:0,status:"active",notes:b.notes||void 0,drive_folder_url:r||void 0}),console.log("\uD83D\uDCCA CRM actualizado exitosamente")}catch(e){console.warn("Error actualizando CRM (no cr\xedtico):",e)}let c=await O.qi.getByPatient(b.id);Y(c),Z(i.id);let l="";l="ai-generated"===o&&r?"\xa1Informe cl\xednico generado por IA y guardado en Google Drive exitosamente!":"ai-generated"===o?"\xa1Informe cl\xednico generado por IA exitosamente! (Guardado localmente - Google Drive no disponible)":r?"\xa1Informe estructurado creado y guardado en Google Drive exitosamente!":"\xa1Informe estructurado creado exitosamente! (Guardado localmente - Google Drive no disponible)",x.Am.success(l,{duration:6e3}),j(""),L(""),et(),ei()}catch(e){console.error("Error generating report:",e),x.Am.error("Error al generar el informe: ".concat(e instanceof Error?e.message:"Error desconocido"))}finally{P(!1)}},em=e=>({primera_visita:"Informe Primera Visita",seguimiento:"Informe Seguimiento"})[e]||e,eh=e=>e?new Date(e).toLocaleDateString("es-ES"):"No especificada";return b?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.Z,{}),(0,n.jsxs)("div",{className:"container mx-auto max-w-6xl px-6 py-8 space-y-8",children:[(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsxs)("h1",{className:"font-lora text-3xl font-bold mb-2",children:["Registro de Sesi\xf3n - ",b.name]}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"Sistema h\xedbrido de documentaci\xf3n cl\xednica con IA y fallbacks robustos"}),(0,n.jsx)("p",{className:"text-sm mt-1 ".concat("working"===V&&"working"===H?"text-green-600":"fallback"===V||"no-permissions"===H?"text-yellow-600":"text-gray-500"),children:"working"===V&&"working"===H?"IA + Google Drive operativos":"working"===V&&"no-permissions"===H?"IA operativa - Drive sin permisos":"fallback"===V&&"working"===H?"Informes estructurados + Google Drive":"fallback"===V&&"no-permissions"===H?"Informes estructurados - Drive sin permisos":"Estado del sistema: Verificando..."})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)(s.Zb,{children:[(0,n.jsx)(s.Ol,{children:(0,n.jsx)(s.ll,{children:"Registro de la Sesi\xf3n"})}),(0,n.jsxs)(s.aY,{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h3",{className:"font-semibold",children:"Grabaci\xf3n de Sesi\xf3n"}),(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)(i.z,{onClick:ea?es:er,variant:ea?"destructive":"default",size:"lg",className:"bg-primary hover:bg-primary/90",disabled:M,children:ea?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(u,{className:"w-4 h-4 mr-2"}),"Parar Grabaci\xf3n"]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m,{className:"w-4 h-4 mr-2"}),"Empezar Grabaci\xf3n"]})}),ea&&(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),(0,n.jsx)("span",{className:"font-mono text-lg font-semibold",children:en})]}),M&&(0,n.jsxs)("div",{className:"flex items-center gap-2 text-blue-600",children:[(0,n.jsx)("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full  animate-spin"}),(0,n.jsx)("span",{className:"text-sm",children:"working"===V?"Transcribiendo con Whisper...":"Procesando audio..."})]})]}),eo&&!ea&&(0,n.jsx)(s.Zb,{className:B.includes("Pendiente transcripci\xf3n manual")?"border-yellow-200 bg-yellow-50":"border-green-200 bg-green-50",children:(0,n.jsx)(s.aY,{className:"p-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("p",{className:"font-medium",children:["Grabaci\xf3n finalizada - ",en]}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"".concat(new Date().toLocaleDateString(),"_").concat(en,"_").concat(X,"_session.wav")}),B&&!B.includes("Pendiente transcripci\xf3n manual")&&(0,n.jsxs)("p",{className:"text-xs text-green-700 mt-1",children:["✓ Transcrito autom\xe1ticamente (",B.length," caracteres)"]}),B&&B.includes("Pendiente transcripci\xf3n manual")&&(0,n.jsx)("p",{className:"text-xs text-yellow-700 mt-1",children:"⚠ Transcripci\xf3n autom\xe1tica no disponible - Informaci\xf3n b\xe1sica guardada"})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(i.z,{variant:"outline",size:"sm",onClick:ec,children:(0,n.jsx)(m,{className:"w-4 h-4"})}),(0,n.jsx)(i.z,{variant:"outline",size:"sm",onClick:ei,children:(0,n.jsx)(h.Z,{className:"w-4 h-4"})})]})]})})}),B&&(0,n.jsx)(s.Zb,{className:B.includes("Pendiente transcripci\xf3n manual")?"border-yellow-200 bg-yellow-50":"border-blue-200 bg-blue-50",children:(0,n.jsxs)(s.aY,{className:"p-4",children:[(0,n.jsx)("h4",{className:"font-medium mb-2 ".concat(B.includes("Pendiente transcripci\xf3n manual")?"text-yellow-800":"text-blue-800"),children:B.includes("Pendiente transcripci\xf3n manual")?"Informaci\xf3n del Audio":"Transcripci\xf3n Autom\xe1tica"}),(0,n.jsx)("p",{className:"text-sm max-h-32 overflow-y-auto ".concat(B.includes("Pendiente transcripci\xf3n manual")?"text-yellow-700":"text-blue-700"),children:B})]})})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",children:"Notas Cl\xednicas"}),(0,n.jsx)(c.g,{placeholder:"Observaciones cl\xednicas, contexto de la sesi\xf3n, notas importantes...",value:A,onChange:e=>j(e.target.value),className:"min-h-[150px] resize-none"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",children:"Archivos Adicionales"}),(0,n.jsx)(C,{files:Q,onFilesSelected:$,onFileRemove:ee,acceptedTypes:".wav,.mp3,.m4a,.txt,.pdf,.doc,.docx",maxFiles:5})]}),(0,n.jsxs)("div",{className:"bg-gray-50 p-3 rounded-lg",children:[(0,n.jsxs)("p",{className:"text-sm text-gray-600",children:[(0,n.jsx)("strong",{children:"Contenido del informe:"})," ",(()=>{let e=[];return A.trim()&&e.push("Notas (".concat(A.length," chars)")),B.trim()&&e.push("Transcripci\xf3n (".concat(B.length," chars)")),Q.length>0&&e.push("".concat(Q.length," archivos")),e.join(" + ")||"Sin contenido"})()]}),(0,n.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Sistema: ","working"===V?"IA disponible":"Informes estructurados"," | Drive: ","working"===H?"Conectado":"Sin permisos"]})]})]})]}),(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[(0,n.jsxs)(i.z,{variant:"outline",size:"lg",onClick:()=>{let e={patient_id:null==b?void 0:b.id,patient_name:null==b?void 0:b.name,notes:A,transcription:B,files:Q.map(e=>e.name),hasRecording:!!eo,recordingDuration:en,timestamp:new Date().toISOString()};localStorage.setItem("session_draft",JSON.stringify(e)),x.Am.success("Borrador guardado localmente")},className:"flex items-center  gap-2",children:[(0,n.jsx)(g.Z,{className:"w-4 h-4"}),"Guardar Borrador"]}),(0,n.jsx)(i.z,{variant:"outline",size:"lg",onClick:()=>{try{let e=localStorage.getItem("session_draft");if(e){let t=JSON.parse(e);t.notes&&j(t.notes),t.transcription&&L(t.transcription),x.Am.success("Borrador cargado")}else x.Am.error("No hay borrador guardado")}catch(e){console.error("Error loading draft:",e),x.Am.error("Error al cargar el borrador")}},className:"flex items-center gap-2",children:"Cargar Borrador"}),(0,n.jsxs)(i.z,{size:"lg",onClick:eu,disabled:D||M,className:"bg-primary hover:bg-primary/90 flex items-center gap-2",children:[(0,n.jsx)(f,{className:"w-4 h-4"}),D?"Generando Informe...":"working"===V?"Generar con IA":"Generar Informe Estructurado"]})]}),("fallback"===V||"no-permissions"===H)&&(0,n.jsx)(s.Zb,{className:"border-yellow-200 bg-yellow-50",children:(0,n.jsx)(s.aY,{className:"p-4",children:(0,n.jsxs)("div",{className:"flex items-start gap-3",children:[(0,n.jsx)(v.Z,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),(0,n.jsxs)("div",{className:"text-sm",children:[(0,n.jsx)("p",{className:"font-medium text-yellow-800",children:"Sistema funcionando en modo h\xedbrido"}),"fallback"===V&&(0,n.jsx)("p",{className:"text-yellow-700",children:"• IA no disponible - Usando informes estructurados profesionales"}),"no-permissions"===H&&(0,n.jsx)("p",{className:"text-yellow-700",children:"• Google Drive sin permisos - Informes guardados localmente"}),(0,n.jsx)("p",{className:"text-yellow-600 text-xs mt-1",children:"Los informes se crean correctamente independientemente del estado de los servicios externos."})]})]})})})]}),(0,n.jsx)("div",{className:"space-y-8",children:(0,n.jsxs)(s.Zb,{children:[(0,n.jsx)(s.Ol,{children:(0,n.jsxs)(s.ll,{className:"font-serif text-lg flex items-center",children:[(0,n.jsx)(d.Z,{className:"mr-2 h-5 w-5"}),"Actividad - Informes"]})}),(0,n.jsx)(s.aY,{className:"space-y-4",children:(0,n.jsx)("div",{className:"h-60 overflow-y-auto custom-scrollbar space-y-4 pr-2",children:W.length>0?W.map(e=>(0,n.jsx)("div",{className:"border rounded-lg p-4 hover:bg-muted/30 transition-colors",children:(0,n.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("h4",{className:"font-medium text-foreground text-sm leading-tight",children:e.title}),(0,n.jsxs)("div",{className:"flex items-center space-x-2 mt-2 text-xs text-muted-foreground",children:[(0,n.jsx)(w.Z,{className:"h-3 w-3"}),(0,n.jsx)("span",{children:eh(e.created_at)}),(0,n.jsx)("span",{children:"•"}),(0,n.jsx)(l.C,{variant:"outline",className:"text-xs",children:"primera_visita"===e.report_type?"Primera Visita":"Seguimiento"})]})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,n.jsx)(l.C,{variant:"completed"===e.status?"default":"secondary",className:"text-xs",children:"completed"===e.status?"Completado":"Borrador"}),e.google_drive_file_id&&(0,n.jsx)("a",{href:"https://docs.google.com/document/d/".concat(e.google_drive_file_id,"/edit"),target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:text-primary/80 transition-colors",title:"Abrir informe en Google Drive",children:(0,n.jsx)(y.Z,{className:"h-4 w-4"})})]})]})},e.id)):(0,n.jsxs)("div",{className:"text-center py-8",children:[(0,n.jsx)(d.Z,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Sin informes registrados"})]})})})]})})]})]})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.Z,{}),(0,n.jsx)("div",{className:"container mx-auto max-w-6xl px-6 py-8",children:(0,n.jsxs)("div",{className:"text-center py-12",children:[(0,n.jsx)(d.Z,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),(0,n.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Paciente no encontrado"}),(0,n.jsx)("p",{className:"text-muted-foreground mb-6",children:"El paciente especificado no existe o no tienes acceso a \xe9l."}),(0,n.jsx)(i.z,{onClick:()=>a.push("/patient-list"),children:"Volver a lista de pacientes"})]})})]})}},6281:function(e,t,a){"use strict";a.d(t,{AuthProvider:function(){return i},a:function(){return c}});var n=a(7437),o=a(2265),r=a(5452);let s=(0,o.createContext)({user:null,profile:null,loading:!0,updateProfile:async()=>{},signOut:async()=>{}}),i=e=>{let{children:t}=e,a=(0,r.createClientComponentClient)(),[i,c]=(0,o.useState)(null),[l,d]=(0,o.useState)(null),[p,u]=(0,o.useState)(!0);(0,o.useEffect)(()=>{(async()=>{var e;let{data:{session:t}}=await a.auth.getSession();if(c(null!==(e=null==t?void 0:t.user)&&void 0!==e?e:null),null==t?void 0:t.user){let{data:e}=await a.from("profiles").select("*").eq("id",t.user.id).single();d(e)}u(!1)})();let{data:e}=a.auth.onAuthStateChange((e,t)=>{var n;c(null!==(n=null==t?void 0:t.user)&&void 0!==n?n:null),(null==t?void 0:t.user)?(async()=>{let{data:e}=await a.from("profiles").select("*").eq("id",t.user.id).single();d(e)})():d(null)});return()=>{e.subscription.unsubscribe()}},[a]);let m=async e=>{if(!i)return;let{error:t}=await a.from("profiles").update(e).eq("id",i.id);if(t)throw t;let{data:n}=await a.from("profiles").select("*").eq("id",i.id).single();d(n)},h=async()=>{await a.auth.signOut()};return(0,n.jsx)(s.Provider,{value:{user:i,profile:l,loading:p,updateProfile:m,signOut:h},children:t})},c=()=>{let e=(0,o.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},6362:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]])},3229:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},8930:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]])},6865:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},2489:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])}},function(e){e.O(0,[545,582,990,452,630,849,438,826,971,117,744],function(){return e(e.s=7214)}),_N_E=e.O()}]);